<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Example of plotting live data with websockets and highcharts</title>

<script src = "https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" 
		type = "text/javascript"></script>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript">

// settings 
var MQTTbroker = 'mqtt.ujo.guru';
var MQTTport = 9001;	
var MQTTsubTopic = '6e6b5aac/23817/+/Value'; 

// // sensor settings
// // REM kirjoitan kaiken hardina, ekoja kertoja skriptijavan kanssa hommissa, parantelen kun oppikäyrää tarpeeksi
// var aqs_net_id = '6e6b5aac'
// var aqs_dev_id = '23817'
// // REM varmaan paukkuu koska integer, mennää stringeillä nyt
// var sensor_topic =  aqs_net_id + '/' + aqs_dev_id
// var batt_topic = sensor_topic + '/' + '0' + '/Value'
// var temp_topic = sensor_topic + '/' + '1' + '/Value'
// var humid_topic = sensor_topic + '/' + '2' + '/Value'
// var light_topic = sensor_topic + '/' + '4' + '/Value'

var MQTTclientid = 'web_' + parseInt(Math.random() * 100, 10)

// global variuable for chart
var chart; 
var dataTopics = new Array();
console.log("connecting to MQTTbroker");

//mqtt broker 	
var client = new Paho.MQTT.Client(MQTTbroker, MQTTport, MQTTclientid);
client.onMessageArrived = onMessageArrived;
client.onConnectionLost = onConnectionLost;

//mqtt connecton options including the mqtt broker subscriptions
var options = {
	timeout: 3,
	onSuccess: function () {
		console.log("mqtt connected");
		// Connection succeeded; subscribe to our topics
		client.subscribe(MQTTsubTopic, {qos: 1});
	},
	onFailure: function (message) {
		console.log("Connection failed, ERROR: " + message.errorMessage);
		//window.setTimeout(location.reload(),20000); //wait 20seconds before trying to connect again.
	}
};


function onConnectionLost(responseObject) { 
	//can be used to reconnect on connection lost
	console.log("connection lost: " + responseObject.errorMessage);
	//window.setTimeout(location.reload(),20000); //wait 20seconds before trying to connect again.
};


function onMessageArrived(message) {
	//what is done when a message arrives from the broker
	console.log(message.destinationName, '',message.payloadString);

	//check if it is a new topic, if not add it to the array
	if (dataTopics.indexOf(message.destinationName) < 0){
	    
	    dataTopics.push(message.destinationName); //add new topic to array
	    var y = dataTopics.indexOf(message.destinationName); //get the index no
	    
	    //create new data series for the chart
		var newseries = {
	            id: y,
	            name: message.destinationName,
	            data: []
	            };

		chart.addSeries(newseries); //add the series	    
	    };
	 
	//get the index no of the topic from the array
	var y = dataTopics.indexOf(message.destinationName); 

	//get current epoch time
	var myEpoch = new Date().getTime(); 

	//remove any text spaces from the message
	var thenum = message.payloadString.replace( /^\D+/g, ''); 

	//create the array
	var plotMqtt = [myEpoch, Number(thenum)]; 

	//check if it is a real number and not text
	if (isNumber(thenum)) { 
		console.log('is a propper number, will send to chart.')
		//send it to the plot function
		plot(plotMqtt, y);	
	};
};


function isNumber(n) {
//check if a real number	
	console.log('is no propper number');
	return !isNaN(parseFloat(n)) && isFinite(n);
};


function init() {
//function that is called once the document has loaded

	//i find i have to set this to false if i have trouble with timezones.
	Highcharts.setOptions({
		global: {
			useUTC: false
		}
	});
	// Connect to MQTT broker
	client.connect(options);
};


function plot(point, chartno) {
//this adds the plots to the chart	
	console.log(point);

    var series = chart.series[0],
        // shift if the series is longer than 20
        shift = series.data.length > 20; 
    // add the point
    chart.series[chartno].addPoint(point, true, shift);  
};


$(document).ready(function() {
//settings for the chart
    chart = new Highcharts.Chart({
        chart: {
            renderTo: 'container',
            defaultSeriesType: 'spline'
        },
        title: {
            text: 'Sensorin 32817 näkymä'
        },
        subtitle: {
            text: 'palvelin: ' + MQTTbroker + ': '+ MQTTport + ' topic : ' + MQTTsubTopic
                    },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            maxZoom: 20 * 1000
        },
        yAxis: {
            minPadding: 0.2,
            maxPadding: 0.2,
            title: {
                text: 'arvo',
                margin: 40
            }
        },
        series: []
    });        
});
/* based on javescript example by @bordignon on twitter Feb 2014 */

</script>
<script src="http://code.highcharts.com/stock/highstock.js"></script>
<script src="http://code.highcharts.com/stock/modules/exporting.js"></script>
</head>

<body>
<body onload="init();"><!--Start the javascript ball rolling and connect to the mqtt broker-->
<div id="container" style="height: 500px; min-width: 500px"></div><!-- this the placeholder for the chart-->
	</body>
</html>
