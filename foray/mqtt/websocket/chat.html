<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<!-- message css -->
<style>
#messages {      background-color:rgba();
                font-size:3;
                font-weight:normal;
                line-height:100%;    }

#status {       background-color:rgba();
                font-size:4;
                font-weight:bold;
                color:blue;
                line-height:140%;    }

</style>

<script src = "https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"
        type = "text/javascript"></script>

<script type="text/javascript">

function gmsg(msg) {
    document.writeln(msg + '<br>')
}

// Called after form input is processed
function startConnect() {
    // Generate a random client ID
    var clientID = "web_" + parseInt(Math.random() * 100);

    // Fetch the hostname/IP address and port number from the form
    var host = 'mqtt.ujo.guru' //document.getElementById("host").value;
    var port = 9001 //document.getElementById("port").value;

    // Print output for the user in the messages div
    gmsg("Connecting to " + clientID + "@" + host + ":"  + port)

    // Initialize new Paho client connection
    client = new Paho.MQTT.Client(host, port, clientID);

    // Set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    // Connect the client, if successful, call onConnect function
    client.connect({
        onSuccess: onConnect,
    });
}

// Called when the client connects
function onConnect() {
    // Fetch the MQTT topic from the form
    topic = 'spam/#'

    // Print output for the user in the messages div
    gmsg("Subscribing to: " + topic)    ;

    // Subscribe to the requested topic
    client.subscribe(topic);
}


// Called when the client loses its connection
function onConnectionLost(responseObject) {
    gmsg("connection lost")
    if (responseObject.errorCode !== 0) {
        gmsg("error:" + responseObject.errorMessage);
    }
}

function timestamp() {
    var str = "";

    var currentTime = new Date()
    var hours = currentTime.getHours()
    var minutes = currentTime.getMinutes()
    var seconds = currentTime.getSeconds()

    if (minutes < 10) {
        minutes = "0" + minutes
    }
    if (seconds < 10) {
        seconds = "0" + seconds
    }

    str += hours + ":" + minutes + ":" + seconds + " ";
    return str;
}


// Called when a message arrives
function onMessageArrived(message) {
    // gmsg(message.destinationName + " " + message.payloadString);
    user = message.destinationName.split('/')[1]

    gmsg(timestamp() + " " + user + ": " + message.payloadString)
}

// Called when the disconnection button is pressed
function startDisconnect() {
    client.disconnect();
    gmsg("Disconnected");
}


function send_message() {
        document.getElementById("messages").innerHTML = "";

        var user = document.forms["messages"]["suser"].value;
        var msg = document.forms["messages"]["smessage"].value;
        console.log(msg+":"+user);

        message = new Paho.MQTT.Message(msg);

        message.destinationName = 'spam/'+user;
        client.send(message);
        return false;
   }

</script>

</head>

<body onload="startConnect();"><!--Start the javascript ball rolling and connect to the mqtt broker-->

<div id="messages">

<form name="messages" action="" onsubmit="return send_message()">
        user:           <input type="text" name="suser">
        message:        <input type="text" name="smessage">
                        <input type="submit" value="Submit">
    </form>


</div>
</body>
</html>
